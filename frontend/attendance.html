<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">å‡ºå¸­ç®¡ç†</h2>
            <button onclick="loadPage('dashboard.html')" class="text-blue-600 hover:text-blue-800 font-medium">
                â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
            </button>
        </div>

        <!-- æ—¥ä»˜é¸æŠ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center space-x-4">
                <button onclick="changeDate(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                    â† å‰æ—¥
                </button>
                <input type="date" id="attendance-date" class="px-4 py-2 border rounded-lg" onchange="loadAttendance()">
                <button onclick="changeDate(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                    ç¿Œæ—¥ â†’
                </button>
                <button onclick="setToday()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    ä»Šæ—¥
                </button>
            </div>
        </div>

        <!-- å‡ºå¸­ãƒªã‚¹ãƒˆ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">å‡ºå¸­çŠ¶æ³</h3>
                <div class="text-sm text-gray-600">
                    å‡ºå¸­: <span id="present-count" class="font-semibold text-green-600">0</span> / 
                    åˆè¨ˆ: <span id="total-count" class="font-semibold">0</span>
                </div>
            </div>
            
            <div id="attendance-list" class="space-y-3">
                <div class="text-center py-8 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <div class="mt-6">
                <button onclick="saveAttendance()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function initDataSyncHandler() {
    'use strict';

    // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®æ›´æ–°é–¢æ•°ã‚’ç™»éŒ²
    const pageUpdateHandlers = {
        'dashboard.html': refreshDashboard,
        'reports.html': loadReportData,
        'attendance.html': loadAttendance,
        'users.html': loadUsers,
        'assessments.html': loadAssessments,
        'service-plans.html': loadPlans
    };

    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸åˆ¤å®š
    function getCurrentPage() {
        const path = window.location.pathname;
        const page = path.substring(path.lastIndexOf('/') + 1) || 'index.html';
        return page;
    }

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:storage:change', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Storage change detected:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} updated`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Update failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:data:updated', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Data updated:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} refreshed`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Refresh failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ç›£è¦–ï¼ˆåˆ¥ã‚¿ãƒ–ãƒ»ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–“åŒæœŸï¼‰
    window.addEventListener('storage', async (event) => {
        if (event.key && event.key.startsWith('whale_')) {
            console.log('ğŸ“¡ [Sync Handler] LocalStorage changed:', event.key);

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} synced with other tab`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Cross-tab sync failed:`, error);
                }
            }
        }
    });

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰å¾©å¸°æ™‚ï¼‰
    document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
            console.log('ğŸ‘ï¸ [Sync Handler] Page became visible, refreshing...');

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} refreshed on visibility`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Visibility refresh failed:`, error);
                }
            }
        }
    });

    console.log('âœ… [Sync Handler] Data sync handler initialized');
})();
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    let attendanceData = {};
    let currentDate = new Date();

    (async function initAttendance() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) {
                window.showToast('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                loadPage('dashboard.html');
                return;
            }

            setToday();
            await loadAttendance();
        } catch (error) {
            console.error('Attendance init error:', error);
            window.showToast('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    })();

    function setToday() {
        currentDate = new Date();
        document.getElementById('attendance-date').valueAsDate = currentDate;
        loadAttendance();
    }

    function changeDate(days) {
        currentDate.setDate(currentDate.getDate() + days);
        document.getElementById('attendance-date').valueAsDate = currentDate;
        loadAttendance();
    }

    async function loadAttendance() {
        try {
            const dateInput = document.getElementById('attendance-date');
            currentDate = dateInput.valueAsDate || new Date();

            // å…¨åˆ©ç”¨è€…å–å¾—
            const users = await window.WhaleStorage.getUsers();
            const serviceUsers = users.filter(u => u.role === 'user');

            // å‡ºå¸­è¨˜éŒ²å–å¾—
            const dateStr = currentDate.toISOString().split('T')[0];
            const records = await window.WhaleStorage.getAttendance(dateStr);

            attendanceData = {};
            serviceUsers.forEach(user => {
                const record = records.find(r => r.userId === user._id);
                attendanceData[user._id] = {
                    user: user,
                    present: record ? record.present : false,
                    arrivalTime: record ? record.arrivalTime : '',
                    departureTime: record ? record.departureTime : '',
                    notes: record ? record.notes : ''
                };
            });

            displayAttendance();
        } catch (error) {
            console.error('Load attendance error:', error);
            window.showToast('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    function displayAttendance() {
        const container = document.getElementById('attendance-list');
        const users = Object.values(attendanceData);

        if (users.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
            return;
        }

        const presentCount = users.filter(u => u.present).length;
        document.getElementById('present-count').textContent = presentCount;
        document.getElementById('total-count').textContent = users.length;

        container.innerHTML = users.map(data => `
            <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   data-user-id="${data.user._id}"
                                   ${data.present ? 'checked' : ''}
                                   onchange="togglePresence('${data.user._id}')"
                                   class="w-6 h-6 text-blue-600 rounded">
                            <span class="ml-3 font-medium text-gray-900">${data.user.name}</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="time" 
                               placeholder="åˆ°ç€"
                               value="${data.arrivalTime || ''}"
                               onchange="updateTime('${data.user._id}', 'arrival', this.value)"
                               class="px-3 py-1 border rounded text-sm">
                        <input type="time" 
                               placeholder="é€€å‡º"
                               value="${data.departureTime || ''}"
                               onchange="updateTime('${data.user._id}', 'departure', this.value)"
                               class="px-3 py-1 border rounded text-sm">
                    </div>
                </div>
            </div>
        `).join('');
    }

    function togglePresence(userId) {
        attendanceData[userId].present = !attendanceData[userId].present;
        displayAttendance();
    }

    function updateTime(userId, type, value) {
        if (type === 'arrival') {
            attendanceData[userId].arrivalTime = value;
        } else {
            attendanceData[userId].departureTime = value;
        }
    }

    async function saveAttendance() {
        try {
            const dateStr = currentDate.toISOString().split('T')[0];

            for (const userId in attendanceData) {
                const data = attendanceData[userId];
                await window.WhaleStorage.saveAttendance({
                    userId: userId,
                    attendanceDate: dateStr,
                    present: data.present,
                    arrivalTime: data.arrivalTime,
                    departureTime: data.departureTime,
                    notes: data.notes
                });
            }

            window.showToast('å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        } catch (error) {
            console.error('Save attendance error:', error);
            window.showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }
</script>
