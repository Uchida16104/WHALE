<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É≠„Ç∞„Ç§„É≥ - WHALE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-blue-600 text-white text-4xl p-4 rounded-full mb-4">
                    üêã
                </div>
                <h1 class="text-3xl font-bold text-gray-800">WHALE</h1>
                <p class="text-sm text-gray-600 mt-2">Á¶èÁ•â„ÉªÂåªÁôÇ„ÉªË°åÊîø„Éª‰ªãË≠∑„ÉªÊïôËÇ≤Áµ±Âêà„Ç∑„Çπ„ÉÜ„É†</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="timeout-message" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                „Çª„ÉÉ„Ç∑„Éß„É≥„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label for="organization-id" class="block text-sm font-medium text-gray-700 mb-2">
                        ÊñΩË®≠Ê©üÈñ¢ID
                    </label>
                    <input type="text" 
                           id="organization-id" 
                           name="organizationId" 
                           required
                           autocomplete="username"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           placeholder="ÊñΩË®≠Ê©üÈñ¢ID„ÇíÂÖ•Âäõ">
                </div>

                <div>
                    <label for="user-id" class="block text-sm font-medium text-gray-700 mb-2">
                        „É¶„Éº„Ç∂„ÉºID
                    </label>
                    <input type="text" 
                           id="user-id" 
                           name="userId" 
                           required
                           autocomplete="username"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           placeholder="„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        „Éë„Çπ„ÉØ„Éº„Éâ
                    </label>
                    <input type="password" 
                           id="password" 
                           name="password" 
                           required
                           autocomplete="current-password"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                </div>

                <button type="submit"
                        id="login-button"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    „É≠„Ç∞„Ç§„É≥
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="register.html" 
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ
                </a>
            </div>
        </div>

        <div class="text-center mt-6 text-sm text-gray-600">
            <p>&copy; 2025 WHALE System. Developed by Hirotoshi Uchida</p>
        </div>
    </div>

    <script type="module" src="js/storage.js"></script>
    <script type="module" src="js/auth.js"></script>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        window.WHALE = {
            API_URL: 'https://whale-backend.onrender.com',
            GITHUB_PAGES_URL: 'https://uchida16104.github.io/WHALE',
            VERSION: '2.0.0'
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üêã Login page loaded');

            // „Çπ„Éà„É¨„Éº„Ç∏ÂàùÊúüÂåñ
            await window.WhaleStorage.init();

            // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('timeout') === '1') {
                document.getElementById('timeout-message').classList.remove('hidden');
            }

            // Êó¢„Å´„É≠„Ç∞„Ç§„É≥Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
            const isAuthenticated = await window.WhaleAuth.checkAuth();
            if (isAuthenticated) {
                window.location.href = 'index.html';
                return;
            }

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
            const form = document.getElementById('login-form');
            const button = document.getElementById('login-button');
            const errorDiv = document.getElementById('error-message');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // „Éú„Çø„É≥ÁÑ°ÂäπÂåñ
                button.disabled = true;
                button.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
                errorDiv.classList.add('hidden');

                try {
                    const formData = new FormData(form);
                    const credentials = {
                        organizationId: formData.get('organizationId'),
                        userId: formData.get('userId'),
                        password: formData.get('password')
                    };

                    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!credentials.organizationId || !credentials.userId || !credentials.password) {
                        throw new Error('ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    }

                    // „É≠„Ç∞„Ç§„É≥ÂÆüË°å
                    const result = await window.WhaleAuth.login(credentials);

                    if (result.success) {
                        console.log('‚úÖ Login successful');
                        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                        window.location.href = 'index.html';
                    } else {
                        throw new Error('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    errorDiv.textContent = error.message || 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    errorDiv.classList.remove('hidden');
                    
                    // „Éú„Çø„É≥ÊúâÂäπÂåñ
                    button.disabled = false;
                    button.textContent = '„É≠„Ç∞„Ç§„É≥';
                }
            });

            // Enter„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
            form.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !button.disabled) {
                    form.dispatchEvent(new Event('submit'));
                }
            });
        });
    </script>
</body>
</html>
