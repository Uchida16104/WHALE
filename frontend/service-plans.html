<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¨ˆç”»</h2>
            <div class="space-x-4">
                <button onclick="showCreatePlanModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ï¼‹ æ–°è¦ä½œæˆ
                </button>
                <button onclick="loadPage('dashboard.html')" class="text-blue-600 hover:text-blue-800 font-medium">
                    â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åˆ©ç”¨è€…é¸æŠ</label>
                    <select id="filter-user" class="w-full px-4 py-2 border rounded-lg" onchange="filterPlans()">
                        <option value="">å…¨ã¦ã®åˆ©ç”¨è€…</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="filterPlans()" class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                        æ¤œç´¢
                    </button>
                </div>
            </div>
        </div>

        <!-- è¨ˆç”»ä¸€è¦§ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»ä¸€è¦§</h3>
            <div id="plans-list" class="space-y-4">
                <div class="text-center py-8 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="create-plan-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¨ˆç”»æ–°è¦ä½œæˆ</h3>
            <button onclick="closeCreatePlanModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">Ã—</span>
            </button>
        </div>

        <form id="create-plan-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    åˆ©ç”¨è€…é¸æŠ <span class="text-red-500">*</span>
                </label>
                <select name="userId" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¨ˆç”»é–‹å§‹æ—¥ <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="startDate" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¨ˆç”»çµ‚äº†æ—¥ <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="endDate" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ©ç”¨è€…ã®å¸Œæœ›</label>
                <textarea name="userWish" rows="3"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="åˆ©ç”¨è€…æœ¬äººã®å¸Œæœ›ã‚„ç›®æ¨™ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç·åˆçš„ãªæ”¯æ´æ–¹é‡</label>
                <textarea name="overallPolicy" rows="3"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="ç·åˆçš„ãªæ”¯æ´ã®æ–¹é‡ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é•·æœŸç›®æ¨™</label>
                <textarea name="longTermGoal" rows="2"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="é”æˆæ™‚æœŸï¼š6ãƒ¶æœˆï½1å¹´ç¨‹åº¦"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">çŸ­æœŸç›®æ¨™</label>
                <textarea name="shortTermGoal" rows="2"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="é”æˆæ™‚æœŸï¼š3ãƒ¶æœˆç¨‹åº¦"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å…·ä½“çš„ãªã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</label>
                <textarea name="serviceContent" rows="4"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨®é¡ã€é »åº¦ã€æ™‚é–“ç­‰ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é€±é–“è¨ˆç”»</label>
                <textarea name="weeklyPlan" rows="3"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="1é€±é–“ã®ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç·Šæ€¥æ™‚ã®å¯¾å¿œ</label>
                <textarea name="emergencyResponse" rows="2"
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="ç·Šæ€¥æ™‚ã®é€£çµ¡å…ˆã‚„å¯¾å¿œæ–¹æ³•ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    ä½œæˆã™ã‚‹
                </button>
                <button type="button" onclick="closeCreatePlanModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<!-- è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="view-plan-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¨ˆç”»è©³ç´°</h3>
            <button onclick="closeViewPlanModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">Ã—</span>
            </button>
        </div>
        <div id="plan-detail-content" class="space-y-4">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <div class="mt-6">
            <button onclick="closeViewPlanModal()"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
</div>

<script>
    (function initDataSyncHandler() {
    'use strict';

    // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®æ›´æ–°é–¢æ•°ã‚’ç™»éŒ²
    const pageUpdateHandlers = {
        'dashboard.html': refreshDashboard,
        'reports.html': loadReportData,
        'attendance.html': loadAttendance,
        'users.html': loadUsers,
        'assessments.html': loadAssessments,
        'service-plans.html': loadPlans
    };

    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸åˆ¤å®š
    function getCurrentPage() {
        const path = window.location.pathname;
        const page = path.substring(path.lastIndexOf('/') + 1) || 'index.html';
        return page;
    }

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:storage:change', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Storage change detected:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} updated`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Update failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:data:updated', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Data updated:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} refreshed`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Refresh failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ç›£è¦–ï¼ˆåˆ¥ã‚¿ãƒ–ãƒ»ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–“åŒæœŸï¼‰
    window.addEventListener('storage', async (event) => {
        if (event.key && event.key.startsWith('whale_')) {
            console.log('ğŸ“¡ [Sync Handler] LocalStorage changed:', event.key);

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} synced with other tab`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Cross-tab sync failed:`, error);
                }
            }
        }
    });

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰å¾©å¸°æ™‚ï¼‰
    document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
            console.log('ğŸ‘ï¸ [Sync Handler] Page became visible, refreshing...');

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} refreshed on visibility`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Visibility refresh failed:`, error);
                }
            }
        }
    });

    console.log('âœ… [Sync Handler] Data sync handler initialized');
})();
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    let allPlans = [];
    let allUsers = [];

    (async function initServicePlans() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) {
                window.showToast('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                loadPage('dashboard.html');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
            allUsers = await window.WhaleStorage.getUsers();
            const serviceUsers = allUsers.filter(u => u.role === 'user');

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠè‚¢ã‚’è¨­å®š
            const userSelects = document.querySelectorAll('select[name="userId"], #filter-user');
            userSelects.forEach(select => {
                if (select.name === 'userId') {
                    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                        serviceUsers.map(u => `<option value="${u._id}">${u.name}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">å…¨ã¦ã®åˆ©ç”¨è€…</option>' +
                        serviceUsers.map(u => `<option value="${u._id}">${u.name}</option>`).join('');
                }
            });

            await loadPlans();

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('create-plan-form').addEventListener('submit', handleCreatePlan);

        } catch (error) {
            console.error('Service plans init error:', error);
            window.showToast('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    })();

    async function loadPlans() {
        try {
            const plans = await window.WhaleStorage.getServicePlans();
            allPlans = plans;
            displayPlans(plans);
        } catch (error) {
            console.error('Load plans error:', error);
            window.showToast('ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    function displayPlans(plans) {
        const container = document.getElementById('plans-list');

        if (plans.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        container.innerHTML = plans.map(plan => {
            const user = allUsers.find(u => u._id === plan.userId);
            return `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition cursor-pointer"
                     onclick="viewPlan('${plan._id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${user ? user.name : 'ä¸æ˜'}</div>
                            <div class="text-sm text-gray-600 mt-1">
                                è¨ˆç”»æœŸé–“: ${plan.startDate ? new Date(plan.startDate).toLocaleDateString('ja-JP') : '-'} 
                                ï½ ${plan.endDate ? new Date(plan.endDate).toLocaleDateString('ja-JP') : '-'}
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ${plan.shortTermGoal ? plan.shortTermGoal.substring(0, 80) + '...' : 'ç›®æ¨™æœªè¨­å®š'}
                            </div>
                        </div>
                        <button class="text-blue-600 hover:text-blue-800 text-sm ml-4">
                            è©³ç´° â†’
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterPlans() {
        const filterUserId = document.getElementById('filter-user').value;

        const filtered = filterUserId
            ? allPlans.filter(p => p.userId === filterUserId)
            : allPlans;

        displayPlans(filtered);
    }

    function showCreatePlanModal() {
        document.getElementById('create-plan-modal').classList.remove('hidden');
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
        const today = new Date();
        document.querySelector('input[name="startDate"]').valueAsDate = today;
        // 6ãƒ¶æœˆå¾Œã‚’çµ‚äº†æ—¥ã«è¨­å®š
        const endDate = new Date(today);
        endDate.setMonth(endDate.getMonth() + 6);
        document.querySelector('input[name="endDate"]').valueAsDate = endDate;
    }

    function closeCreatePlanModal() {
        document.getElementById('create-plan-modal').classList.add('hidden');
        document.getElementById('create-plan-form').reset();
    }

    async function handleCreatePlan(e) {
        e.preventDefault();

        try {
            const formData = new FormData(e.target);
            const planData = {
                userId: formData.get('userId'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                userWish: formData.get('userWish'),
                overallPolicy: formData.get('overallPolicy'),
                longTermGoal: formData.get('longTermGoal'),
                shortTermGoal: formData.get('shortTermGoal'),
                serviceContent: formData.get('serviceContent'),
                weeklyPlan: formData.get('weeklyPlan'),
                emergencyResponse: formData.get('emergencyResponse')
            };

            await window.WhaleStorage.createServicePlan(planData);
            window.showToast('ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
            closeCreatePlanModal();
            await loadPlans();

        } catch (error) {
            console.error('Create plan error:', error);
            window.showToast('ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    <!-- service-plans.html ã® viewPlan é–¢æ•°ã‚’ä»¥ä¸‹ã«ä¿®æ­£ -->

<script>
function viewPlan(planId) {
    const plan = allPlans.find(p => p._id === planId);
    if (!plan) return;

    const user = allUsers.find(u => u._id === plan.userId);

    const content = `
        <div id="service-plan-print-content" class="space-y-4">
            <div class="border-b pb-3">
                <label class="text-sm text-gray-600 font-medium">åˆ©ç”¨è€…</label>
                <div class="mt-1 text-lg font-semibold">${user ? user.name : 'ä¸æ˜'}</div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-600 font-medium">è¨ˆç”»é–‹å§‹æ—¥</label>
                    <div class="mt-1">${plan.startDate ? new Date(plan.startDate).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600 font-medium">è¨ˆç”»çµ‚äº†æ—¥</label>
                    <div class="mt-1">${plan.endDate ? new Date(plan.endDate).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
            </div>
            <div>
                <label class="text-sm text-gray-600 font-medium">åˆ©ç”¨è€…ã®å¸Œæœ›</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.userWish || '-'}</div>
            </div>
            <div>
                <label class="text-sm text-gray-600 font-medium">ç·åˆçš„ãªæ”¯æ´æ–¹é‡</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.overallPolicy || '-'}</div>
            </div>
            <div class="border-t pt-3">
                <label class="text-sm text-gray-600 font-medium">é•·æœŸç›®æ¨™</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.longTermGoal || '-'}</div>
            </div>
            <div>
                <label class="text-sm text-gray-600 font-medium">çŸ­æœŸç›®æ¨™</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.shortTermGoal || '-'}</div>
            </div>
            <div class="border-t pt-3">
                <label class="text-sm text-gray-600 font-medium">å…·ä½“çš„ãªã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.serviceContent || '-'}</div>
            </div>
            <div>
                <label class="text-sm text-gray-600 font-medium">é€±é–“è¨ˆç”»</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.weeklyPlan || '-'}</div>
            </div>
            <div>
                <label class="text-sm text-gray-600 font-medium">ç·Šæ€¥æ™‚ã®å¯¾å¿œ</label>
                <div class="mt-1 text-gray-800 whitespace-pre-wrap">${plan.emergencyResponse || '-'}</div>
            </div>
            <div class="border-t pt-3 text-sm text-gray-500">
                ä½œæˆæ—¥æ™‚: ${plan.createdAt ? new Date(plan.createdAt).toLocaleString('ja-JP') : '-'}
            </div>
        </div>
        
        <!-- å°åˆ·ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <div class="mt-6 flex gap-4 no-print">
            <button onclick="printServicePlan()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                ğŸ–¨ï¸ å°åˆ·
            </button>
            <button onclick="exportServicePlanPDF('${planId}')" 
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                ğŸ“„ PDFå‡ºåŠ›
            </button>
            <button onclick="exportServicePlanExcel('${planId}')" 
                    class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                ğŸ“Š Excelå‡ºåŠ›
            </button>
        </div>
    `;

    document.getElementById('plan-detail-content').innerHTML = content;
    document.getElementById('view-plan-modal').classList.remove('hidden');
}

// ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»å°åˆ·
function printServicePlan() {
    const printContent = document.getElementById('service-plan-print-content');
    if (!printContent) return;

    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¨ˆç”» - WHALE</title>
            <style>
                @page {
                    size: A4;
                    margin: 15mm;
                }
                body {
                    font-family: 'Noto Sans JP', 'MS PGothic', sans-serif;
                    padding: 10mm;
                    font-size: 11pt;
                    line-height: 1.6;
                }
                h1 {
                    text-align: center;
                    border-bottom: 3px solid #333;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                    font-size: 18pt;
                }
                .header-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    padding: 10px;
                    background: #f5f5f5;
                    border: 1px solid #ddd;
                }
                .section {
                    margin-bottom: 15px;
                    page-break-inside: avoid;
                    border-left: 3px solid #4A90E2;
                    padding-left: 10px;
                }
                .label {
                    font-weight: bold;
                    color: #333;
                    margin-bottom: 5px;
                    font-size: 10pt;
                }
                .value {
                    margin-left: 10px;
                    line-height: 1.8;
                    white-space: pre-wrap;
                    border: 1px solid #e0e0e0;
                    padding: 8px;
                    background: #fafafa;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 9pt;
                    color: #666;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                }
                @media print {
                    body { padding: 5mm; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <h1>ğŸ‹ WHALE ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¨ˆç”»æ›¸</h1>
            <div class="content">
                ${printContent.innerHTML.replace(/class="[^"]*"/g, '')}
            </div>
            <div class="footer">
                ç™ºè¡Œæ—¥: ${new Date().toLocaleDateString('ja-JP', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}
            </div>
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() { window.close(); }, 100);
                }
            </script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

// ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»PDFå‡ºåŠ›
async function exportServicePlanPDF(planId) {
    try {
        const plan = allPlans.find(p => p._id === planId);
        if (!plan) return;

        const user = allUsers.find(u => u._id === plan.userId);
        const currentUser = await window.WhaleStorage.getCurrentUser();
        const org = await window.WhaleStorage.getOrganization(currentUser.organizationId);

        const data = {
            records: [{
                ...plan,
                userName: user ? user.name : 'ä¸æ˜',
                type: 'service_plan',
                recordDate: plan.startDate
            }],
            analytics: {
                planPeriod: `${plan.startDate} ï½ ${plan.endDate}`
            },
            organization: { name: org.name }
        };

        window.showToast('PDFç”Ÿæˆä¸­...', 'info');
        await window.WhaleStorage.exportPDF(data);
        window.showToast('PDFã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');

    } catch (error) {
        console.error('PDF export error:', error);
        window.showToast('PDFå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    }
}

// ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»Excelå‡ºåŠ›
async function exportServicePlanExcel(planId) {
    try {
        const plan = allPlans.find(p => p._id === planId);
        if (!plan) return;

        const user = allUsers.find(u => u._id === plan.userId);

        const data = {
            records: [{
                æ—¥ä»˜: plan.startDate,
                åˆ©ç”¨è€…å: user ? user.name : 'ä¸æ˜',
                è¨ˆç”»æœŸé–“: `${plan.startDate} ï½ ${plan.endDate}`,
                åˆ©ç”¨è€…ã®å¸Œæœ›: plan.userWish,
                ç·åˆçš„ãªæ”¯æ´æ–¹é‡: plan.overallPolicy,
                é•·æœŸç›®æ¨™: plan.longTermGoal,
                çŸ­æœŸç›®æ¨™: plan.shortTermGoal,
                ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹: plan.serviceContent,
                é€±é–“è¨ˆç”»: plan.weeklyPlan,
                ç·Šæ€¥æ™‚å¯¾å¿œ: plan.emergencyResponse
            }]
        };

        window.showToast('Excelç”Ÿæˆä¸­...', 'info');
        await window.WhaleStorage.exportExcel(data);
        window.showToast('Excelã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');

    } catch (error) {
        console.error('Excel export error:', error);
        window.showToast('Excelå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    }
}

    function closeViewPlanModal() {
        document.getElementById('view-plan-modal').classList.add('hidden');
    }
async function refreshDashboard() {
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    await loadStatistics(currentUser);
    await loadRecentRecords(currentUser);
}

async function loadReportData() {
    // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
}
await window.WhaleStorage.saveDailyRecord(data);
window.dispatchEvent(new CustomEvent('whale:data:updated', {
    detail: { type: 'daily_record', data: result }
}));
</script>
<style>
@media print {
    .no-print {
        display: none !important;
    }
}
</style>
