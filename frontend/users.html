<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">利用者管理</h2>
            <div class="space-x-4">
                <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ＋ 新規登録
                </button>
                <button onclick="loadPage('dashboard.html')" class="text-blue-600 hover:text-blue-800 font-medium">
                    ← ダッシュボードに戻る
                </button>
            </div>
        </div>

        <!-- 検索フィルター -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search-name" placeholder="名前で検索" 
                       class="px-4 py-2 border rounded-lg" onkeyup="filterUsers()">
                <select id="filter-role" class="px-4 py-2 border rounded-lg" onchange="filterUsers()">
                    <option value="">全ての役割</option>
                    <option value="user">利用者</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理者</option>
                </select>
                <button onclick="filterUsers()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    検索
                </button>
            </div>
        </div>

        <!-- 利用者リスト -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">名前</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">役割</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">電話番号</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">登録日</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                読み込み中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    let allUsers = [];

    (async function initUsers() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            if (!currentUser || !currentUser.role || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) {
                window.showToast('権限がありません', 'error');
                loadPage('dashboard.html');
                return;
            }

            await loadUsers();
        } catch (error) {
            console.error('Users page init error:', error);
            window.showToast('初期化エラー', 'error');
        }
    })();

    async function loadUsers() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            const users = await window.WhaleStorage.findByType('user', {
                selector: { type: 'user', organizationId: currentUser.organizationId }
            });

            allUsers = users;
            displayUsers(users);
        } catch (error) {
            console.error('Load users error:', error);
            window.showToast('利用者の読み込みに失敗しました', 'error');
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('users-tbody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">利用者が見つかりません</td></tr>';
            return;
        }

        const roleMap = { admin: '管理者', staff: '職員', user: '利用者' };

        tbody.innerHTML = users.map(user => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="font-medium text-gray-900">${user.name}</div>
                    <div class="text-sm text-gray-500">${user.nameKana}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 text-sm rounded-full ${
                        user.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                        user.role === 'staff' ? 'bg-blue-100 text-blue-800' :
                        'bg-green-100 text-green-800'
                    }">
                        ${roleMap[user.role] || user.role}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">${user.phone || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>
                <td class="px-6 py-4 text-sm space-x-2">
                    <button onclick="viewUser('${user._id}')" class="text-blue-600 hover:text-blue-800">詳細</button>
                    <button onclick="editUser('${user._id}')" class="text-green-600 hover:text-green-800">編集</button>
                </td>
            </tr>
        `).join('');
    }

    function filterUsers() {
        const searchName = document.getElementById('search-name').value.toLowerCase();
        const filterRole = document.getElementById('filter-role').value;

        const filtered = allUsers.filter(user => {
            const nameMatch = !searchName || user.name.toLowerCase().includes(searchName) || user.nameKana.toLowerCase().includes(searchName);
            const roleMatch = !filterRole || user.role === filterRole;
            return nameMatch && roleMatch;
        });

        displayUsers(filtered);
    }

    function showAddUserModal() {
        window.showToast('新規登録機能は準備中です', 'info');
    }

    function viewUser(userId) {
        window.showToast('詳細表示機能は準備中です', 'info');
    }

    function editUser(userId) {
        window.showToast('編集機能は準備中です', 'info');
    }
</script>
