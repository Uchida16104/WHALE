<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">åˆ©ç”¨è€…ç®¡ç†</h2>
            <div class="space-x-4">
                <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ï¼‹ æ–°è¦ç™»éŒ²
                </button>
                <button onclick="loadPage('dashboard.html')" class="text-blue-600 hover:text-blue-800 font-medium">
                    â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search-name" placeholder="åå‰ã§æ¤œç´¢" 
                       class="px-4 py-2 border rounded-lg" onkeyup="filterUsers()">
                <select id="filter-role" class="px-4 py-2 border rounded-lg" onchange="filterUsers()">
                    <option value="">å…¨ã¦ã®å½¹å‰²</option>
                    <option value="user">åˆ©ç”¨è€…</option>
                    <option value="staff">è·å“¡</option>
                    <option value="admin">ç®¡ç†è€…</option>
                </select>
                <button onclick="filterUsers()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    æ¤œç´¢
                </button>
            </div>
        </div>

        <!-- åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">åå‰</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å½¹å‰²</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é›»è©±ç•ªå·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç™»éŒ²æ—¥</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                èª­ã¿è¾¼ã¿ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="add-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">åˆ©ç”¨è€…æ–°è¦ç™»éŒ²</h3>
            <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">Ã—</span>
            </button>
        </div>

        <form id="add-user-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        åå‰ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ãƒ•ãƒªã‚¬ãƒŠ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="nameKana" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ID <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="userId" required
                           pattern="[a-zA-Z0-9_-]+"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="text-red-500">*</span>
                    </label>
                    <input type="password" name="password" required
                           minlength="8"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å½¹å‰² <span class="text-red-500">*</span>
                    </label>
                    <select name="role" required
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="user">åˆ©ç”¨è€…</option>
                        <option value="staff">è·å“¡</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        é›»è©±ç•ªå·
                    </label>
                    <input type="tel" name="phone"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        éƒµä¾¿ç•ªå·
                    </label>
                    <input type="text" name="postalCode"
                           placeholder="000-0000"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        èª•ç”Ÿæ—¥
                    </label>
                    <input type="date" name="birthday"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ä½æ‰€
                    </label>
                    <input type="text" name="address"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    ç™»éŒ²ã™ã‚‹
                </button>
                <button type="button" onclick="closeAddUserModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<!-- è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="view-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">åˆ©ç”¨è€…è©³ç´°</h3>
            <button onclick="closeViewUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">Ã—</span>
            </button>
        </div>
        <div id="user-detail-content" class="space-y-4">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <div class="mt-6">
            <button onclick="closeViewUserModal()"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">åˆ©ç”¨è€…ç·¨é›†</h3>
            <button onclick="closeEditUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">Ã—</span>
            </button>
        </div>

        <form id="edit-user-form" class="space-y-4">
            <input type="hidden" name="userId" id="edit-user-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰</label>
                    <input type="text" name="name" id="edit-name"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ•ãƒªã‚¬ãƒŠ</label>
                    <input type="text" name="nameKana" id="edit-name-kana"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©±ç•ªå·</label>
                    <input type="tel" name="phone" id="edit-phone"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">éƒµä¾¿ç•ªå·</label>
                    <input type="text" name="postalCode" id="edit-postal-code"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä½æ‰€</label>
                    <input type="text" name="address" id="edit-address"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    æ›´æ–°ã™ã‚‹
                </button>
                <button type="button" onclick="closeEditUserModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    (function initDataSyncHandler() {
    'use strict';

    // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®æ›´æ–°é–¢æ•°ã‚’ç™»éŒ²
    const pageUpdateHandlers = {
        'dashboard.html': refreshDashboard,
        'reports.html': loadReportData,
        'attendance.html': loadAttendance,
        'users.html': loadUsers,
        'assessments.html': loadAssessments,
        'service-plans.html': loadPlans
    };

    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸åˆ¤å®š
    function getCurrentPage() {
        const path = window.location.pathname;
        const page = path.substring(path.lastIndexOf('/') + 1) || 'index.html';
        return page;
    }

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:storage:change', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Storage change detected:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} updated`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Update failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('whale:data:updated', async (event) => {
        console.log('ğŸ“¡ [Sync Handler] Data updated:', event.detail);

        const currentPage = getCurrentPage();
        const updateHandler = pageUpdateHandlers[currentPage];

        if (updateHandler && typeof updateHandler === 'function') {
            try {
                await updateHandler();
                console.log(`âœ… [Sync Handler] ${currentPage} refreshed`);
            } catch (error) {
                console.error(`âŒ [Sync Handler] Refresh failed for ${currentPage}:`, error);
            }
        }
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ç›£è¦–ï¼ˆåˆ¥ã‚¿ãƒ–ãƒ»ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–“åŒæœŸï¼‰
    window.addEventListener('storage', async (event) => {
        if (event.key && event.key.startsWith('whale_')) {
            console.log('ğŸ“¡ [Sync Handler] LocalStorage changed:', event.key);

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} synced with other tab`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Cross-tab sync failed:`, error);
                }
            }
        }
    });

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰å¾©å¸°æ™‚ï¼‰
    document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
            console.log('ğŸ‘ï¸ [Sync Handler] Page became visible, refreshing...');

            const currentPage = getCurrentPage();
            const updateHandler = pageUpdateHandlers[currentPage];

            if (updateHandler && typeof updateHandler === 'function') {
                try {
                    await updateHandler();
                    console.log(`âœ… [Sync Handler] ${currentPage} refreshed on visibility`);
                } catch (error) {
                    console.error(`âŒ [Sync Handler] Visibility refresh failed:`, error);
                }
            }
        }
    });

    console.log('âœ… [Sync Handler] Data sync handler initialized');
})();
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    let allUsers = [];
    let currentEditingUser = null;

    (async function initUsers() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) {
                window.showToast('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                loadPage('dashboard.html');
                return;
            }

            await loadUsers();

            // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('add-user-form').addEventListener('submit', handleAddUser);

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('edit-user-form').addEventListener('submit', handleEditUser);

        } catch (error) {
            console.error('Users page init error:', error);
            window.showToast('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    })();

    async function loadUsers() {
        try {
            const users = await window.WhaleStorage.getUsers();
            allUsers = users;
            displayUsers(users);
        } catch (error) {
            console.error('Load users error:', error);
            window.showToast('åˆ©ç”¨è€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('users-tbody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        const roleMap = { admin: 'ç®¡ç†è€…', staff: 'è·å“¡', user: 'åˆ©ç”¨è€…' };

        tbody.innerHTML = users.map(user => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="font-medium text-gray-900">${user.name}</div>
                    <div class="text-sm text-gray-500">${user.nameKana || ''}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 text-sm rounded-full ${
                        user.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                        user.role === 'staff' ? 'bg-blue-100 text-blue-800' :
                        'bg-green-100 text-green-800'
                    }">
                        ${roleMap[user.role] || user.role}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">${user.phone || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '-'}</td>
                <td class="px-6 py-4 text-sm space-x-2">
                    <button onclick="viewUser('${user._id}')" class="text-blue-600 hover:text-blue-800">è©³ç´°</button>
                    <button onclick="editUser('${user._id}')" class="text-green-600 hover:text-green-800">ç·¨é›†</button>
                </td>
            </tr>
        `).join('');
    }

    function filterUsers() {
        const searchName = document.getElementById('search-name').value.toLowerCase();
        const filterRole = document.getElementById('filter-role').value;

        const filtered = allUsers.filter(user => {
            const nameMatch = !searchName || 
                user.name.toLowerCase().includes(searchName) || 
                (user.nameKana && user.nameKana.toLowerCase().includes(searchName));
            const roleMatch = !filterRole || user.role === filterRole;
            return nameMatch && roleMatch;
        });

        displayUsers(filtered);
    }

    function showAddUserModal() {
        document.getElementById('add-user-modal').classList.remove('hidden');
    }

    function closeAddUserModal() {
        document.getElementById('add-user-modal').classList.add('hidden');
        document.getElementById('add-user-form').reset();
    }

    async function handleAddUser(e) {
        e.preventDefault();

        try {
            const formData = new FormData(e.target);
            const userData = {
                userId: formData.get('userId'),
                name: formData.get('name'),
                nameKana: formData.get('nameKana'),
                password: formData.get('password'),
                role: formData.get('role'),
                phone: formData.get('phone'),
                postalCode: formData.get('postalCode'),
                address: formData.get('address'),
                birthday: formData.get('birthday')
            };

            await window.WhaleStorage.createUser(userData);
            window.showToast('åˆ©ç”¨è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
            closeAddUserModal();
            await loadUsers();

        } catch (error) {
            console.error('Add user error:', error);
            window.showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    function viewUser(userId) {
        const user = allUsers.find(u => u._id === userId);
        if (!user) return;

        const roleMap = { admin: 'ç®¡ç†è€…', staff: 'è·å“¡', user: 'åˆ©ç”¨è€…' };

        const content = `
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-gray-600">åå‰</label>
                    <div class="font-medium">${user.name}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">ãƒ•ãƒªã‚¬ãƒŠ</label>
                    <div class="font-medium">${user.nameKana || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">å½¹å‰²</label>
                    <div class="font-medium">${roleMap[user.role] || user.role}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                    <div class="font-medium">${user.userId || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">é›»è©±ç•ªå·</label>
                    <div class="font-medium">${user.phone || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">éƒµä¾¿ç•ªå·</label>
                    <div class="font-medium">${user.postalCode || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">ä½æ‰€</label>
                    <div class="font-medium">${user.address || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">èª•ç”Ÿæ—¥</label>
                    <div class="font-medium">${user.birthday ? new Date(user.birthday).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">ç™»éŒ²æ—¥</label>
                    <div class="font-medium">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
            </div>
        `;

        document.getElementById('user-detail-content').innerHTML = content;
        document.getElementById('view-user-modal').classList.remove('hidden');
    }

    function closeViewUserModal() {
        document.getElementById('view-user-modal').classList.add('hidden');
    }

    function editUser(userId) {
        const user = allUsers.find(u => u._id === userId);
        if (!user) return;

        currentEditingUser = user;

        document.getElementById('edit-user-id').value = user._id;
        document.getElementById('edit-name').value = user.name || '';
        document.getElementById('edit-name-kana').value = user.nameKana || '';
        document.getElementById('edit-phone').value = user.phone || '';
        document.getElementById('edit-postal-code').value = user.postalCode || '';
        document.getElementById('edit-address').value = user.address || '';

        document.getElementById('edit-user-modal').classList.remove('hidden');
    }

    function closeEditUserModal() {
        document.getElementById('edit-user-modal').classList.add('hidden');
        document.getElementById('edit-user-form').reset();
        currentEditingUser = null;
    }

    async function handleEditUser(e) {
        e.preventDefault();

        if (!currentEditingUser) return;

        try {
            const formData = new FormData(e.target);
            const updates = {
                name: formData.get('name'),
                nameKana: formData.get('nameKana'),
                phone: formData.get('phone'),
                postalCode: formData.get('postalCode'),
                address: formData.get('address')
            };

            await window.WhaleStorage.updateUser(currentEditingUser._id, updates);
            window.showToast('åˆ©ç”¨è€…æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            closeEditUserModal();
            await loadUsers();

        } catch (error) {
            console.error('Update user error:', error);
            window.showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    async function refreshDashboard() {
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    await loadStatistics(currentUser);
    await loadRecentRecords(currentUser);
}

async function loadReportData() {
    // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
}
await window.WhaleStorage.saveDailyRecord(data);
window.dispatchEvent(new CustomEvent('whale:data:updated', {
    detail: { type: 'daily_record', data: result }
}));
</script>
