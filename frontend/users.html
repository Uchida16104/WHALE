<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">利用者管理</h2>
            <div class="space-x-4">
                <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ＋ 新規登録
                </button>
                <button onclick="loadPage('dashboard.html')" class="text-blue-600 hover:text-blue-800 font-medium">
                    ← ダッシュボードに戻る
                </button>
            </div>
        </div>

        <!-- 検索フィルター -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search-name" placeholder="名前で検索" 
                       class="px-4 py-2 border rounded-lg" onkeyup="filterUsers()">
                <select id="filter-role" class="px-4 py-2 border rounded-lg" onchange="filterUsers()">
                    <option value="">全ての役割</option>
                    <option value="user">利用者</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理者</option>
                </select>
                <button onclick="filterUsers()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    検索
                </button>
            </div>
        </div>

        <!-- 利用者リスト -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">名前</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">役割</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">電話番号</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">登録日</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                読み込み中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 新規登録モーダル -->
<div id="add-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">利用者新規登録</h3>
            <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">×</span>
            </button>
        </div>

        <form id="add-user-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        名前 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        フリガナ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="nameKana" required
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ユーザーID <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="userId" required
                           pattern="[a-zA-Z0-9_-]+"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        パスワード <span class="text-red-500">*</span>
                    </label>
                    <input type="password" name="password" required
                           minlength="8"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        役割 <span class="text-red-500">*</span>
                    </label>
                    <select name="role" required
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="user">利用者</option>
                        <option value="staff">職員</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        電話番号
                    </label>
                    <input type="tel" name="phone"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        郵便番号
                    </label>
                    <input type="text" name="postalCode"
                           placeholder="000-0000"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        誕生日
                    </label>
                    <input type="date" name="birthday"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        住所
                    </label>
                    <input type="text" name="address"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    登録する
                </button>
                <button type="button" onclick="closeAddUserModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    キャンセル
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 詳細表示モーダル -->
<div id="view-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">利用者詳細</h3>
            <button onclick="closeViewUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">×</span>
            </button>
        </div>
        <div id="user-detail-content" class="space-y-4">
            <!-- 動的に生成 -->
        </div>
        <div class="mt-6">
            <button onclick="closeViewUserModal()"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                閉じる
            </button>
        </div>
    </div>
</div>

<!-- 編集モーダル -->
<div id="edit-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">利用者編集</h3>
            <button onclick="closeEditUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="text-2xl">×</span>
            </button>
        </div>

        <form id="edit-user-form" class="space-y-4">
            <input type="hidden" name="userId" id="edit-user-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">名前</label>
                    <input type="text" name="name" id="edit-name"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">フリガナ</label>
                    <input type="text" name="nameKana" id="edit-name-kana"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                    <input type="tel" name="phone" id="edit-phone"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">郵便番号</label>
                    <input type="text" name="postalCode" id="edit-postal-code"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">住所</label>
                    <input type="text" name="address" id="edit-address"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    更新する
                </button>
                <button type="button" onclick="closeEditUserModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    キャンセル
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    let allUsers = [];
    let currentEditingUser = null;

    (async function initUsers() {
        try {
            const currentUser = await window.WhaleStorage.getCurrentUser();
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) {
                window.showToast('権限がありません', 'error');
                loadPage('dashboard.html');
                return;
            }

            await loadUsers();

            // 新規登録フォーム送信
            document.getElementById('add-user-form').addEventListener('submit', handleAddUser);

            // 編集フォーム送信
            document.getElementById('edit-user-form').addEventListener('submit', handleEditUser);

        } catch (error) {
            console.error('Users page init error:', error);
            window.showToast('初期化エラー: ' + error.message, 'error');
        }
    })();

    async function loadUsers() {
        try {
            const users = await window.WhaleStorage.getUsers();
            allUsers = users;
            displayUsers(users);
        } catch (error) {
            console.error('Load users error:', error);
            window.showToast('利用者の読み込みに失敗しました', 'error');
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('users-tbody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">利用者が見つかりません</td></tr>';
            return;
        }

        const roleMap = { admin: '管理者', staff: '職員', user: '利用者' };

        tbody.innerHTML = users.map(user => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="font-medium text-gray-900">${user.name}</div>
                    <div class="text-sm text-gray-500">${user.nameKana || ''}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 text-sm rounded-full ${
                        user.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                        user.role === 'staff' ? 'bg-blue-100 text-blue-800' :
                        'bg-green-100 text-green-800'
                    }">
                        ${roleMap[user.role] || user.role}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">${user.phone || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '-'}</td>
                <td class="px-6 py-4 text-sm space-x-2">
                    <button onclick="viewUser('${user._id}')" class="text-blue-600 hover:text-blue-800">詳細</button>
                    <button onclick="editUser('${user._id}')" class="text-green-600 hover:text-green-800">編集</button>
                </td>
            </tr>
        `).join('');
    }

    function filterUsers() {
        const searchName = document.getElementById('search-name').value.toLowerCase();
        const filterRole = document.getElementById('filter-role').value;

        const filtered = allUsers.filter(user => {
            const nameMatch = !searchName || 
                user.name.toLowerCase().includes(searchName) || 
                (user.nameKana && user.nameKana.toLowerCase().includes(searchName));
            const roleMatch = !filterRole || user.role === filterRole;
            return nameMatch && roleMatch;
        });

        displayUsers(filtered);
    }

    function showAddUserModal() {
        document.getElementById('add-user-modal').classList.remove('hidden');
    }

    function closeAddUserModal() {
        document.getElementById('add-user-modal').classList.add('hidden');
        document.getElementById('add-user-form').reset();
    }

    async function handleAddUser(e) {
        e.preventDefault();

        try {
            const formData = new FormData(e.target);
            const userData = {
                userId: formData.get('userId'),
                name: formData.get('name'),
                nameKana: formData.get('nameKana'),
                password: formData.get('password'),
                role: formData.get('role'),
                phone: formData.get('phone'),
                postalCode: formData.get('postalCode'),
                address: formData.get('address'),
                birthday: formData.get('birthday')
            };

            await window.WhaleStorage.createUser(userData);
            window.showToast('利用者を登録しました', 'success');
            closeAddUserModal();
            await loadUsers();

        } catch (error) {
            console.error('Add user error:', error);
            window.showToast('登録エラー: ' + error.message, 'error');
        }
    }

    function viewUser(userId) {
        const user = allUsers.find(u => u._id === userId);
        if (!user) return;

        const roleMap = { admin: '管理者', staff: '職員', user: '利用者' };

        const content = `
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-gray-600">名前</label>
                    <div class="font-medium">${user.name}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">フリガナ</label>
                    <div class="font-medium">${user.nameKana || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">役割</label>
                    <div class="font-medium">${roleMap[user.role] || user.role}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">ユーザーID</label>
                    <div class="font-medium">${user.userId || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">電話番号</label>
                    <div class="font-medium">${user.phone || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">郵便番号</label>
                    <div class="font-medium">${user.postalCode || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">住所</label>
                    <div class="font-medium">${user.address || '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">誕生日</label>
                    <div class="font-medium">${user.birthday ? new Date(user.birthday).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
                <div>
                    <label class="text-sm text-gray-600">登録日</label>
                    <div class="font-medium">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '-'}</div>
                </div>
            </div>
        `;

        document.getElementById('user-detail-content').innerHTML = content;
        document.getElementById('view-user-modal').classList.remove('hidden');
    }

    function closeViewUserModal() {
        document.getElementById('view-user-modal').classList.add('hidden');
    }

    function editUser(userId) {
        const user = allUsers.find(u => u._id === userId);
        if (!user) return;

        currentEditingUser = user;

        document.getElementById('edit-user-id').value = user._id;
        document.getElementById('edit-name').value = user.name || '';
        document.getElementById('edit-name-kana').value = user.nameKana || '';
        document.getElementById('edit-phone').value = user.phone || '';
        document.getElementById('edit-postal-code').value = user.postalCode || '';
        document.getElementById('edit-address').value = user.address || '';

        document.getElementById('edit-user-modal').classList.remove('hidden');
    }

    function closeEditUserModal() {
        document.getElementById('edit-user-modal').classList.add('hidden');
        document.getElementById('edit-user-form').reset();
        currentEditingUser = null;
    }

    async function handleEditUser(e) {
        e.preventDefault();

        if (!currentEditingUser) return;

        try {
            const formData = new FormData(e.target);
            const updates = {
                name: formData.get('name'),
                nameKana: formData.get('nameKana'),
                phone: formData.get('phone'),
                postalCode: formData.get('postalCode'),
                address: formData.get('address')
            };

            await window.WhaleStorage.updateUser(currentEditingUser._id, updates);
            window.showToast('利用者情報を更新しました', 'success');
            closeEditUserModal();
            await loadUsers();

        } catch (error) {
            console.error('Update user error:', error);
            window.showToast('更新エラー: ' + error.message, 'error');
        }
    }
</script>
