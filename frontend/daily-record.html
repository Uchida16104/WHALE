<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Êó•„ÄÖ„ÅÆË®òÈå≤</h2>
                <p class="text-sm text-gray-600 mt-1" id="record-date"></p>
            </div>
            <button onclick="loadPage('dashboard.html')" 
                    class="text-blue-600 hover:text-blue-800 font-medium">
                ‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã
            </button>
        </div>

        <form id="daily-record-form" class="space-y-6">
            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Âü∫Êú¨ÊÉÖÂ†±</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ëµ∑Â∫äÊôÇÈñì</label>
                        <input type="time" name="wakeUpTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Â∞±ÂØùÊôÇÈñì</label>
                        <input type="time" name="sleepTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄöÊâÄÊôÇÈñì</label>
                        <input type="time" name="arrivalTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄÄÊâÄÊôÇÈñì</label>
                        <input type="time" name="departureTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- È£ü‰∫ã -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">È£ü‰∫ã</h3>
                <div class="space-y-4">
                    <div class="border-b pb-4">
                        <div class="flex items-center space-x-4 mb-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="breakfast" value="1" class="w-5 h-5 text-blue-600 rounded">
                                <span class="ml-2 font-medium">ÊúùÈ£ü</span>
                            </label>
                            <label class="text-sm text-gray-600">
                                È£üÊ¨≤: <input type="range" name="breakfastAppetite" min="1" max="10" value="5" class="ml-2 w-32">
                                <span class="ml-2" id="breakfast-appetite-value">5</span>/10
                            </label>
                        </div>
                        <textarea name="breakfastContent" rows="2" placeholder="È£ü‰∫ãÂÜÖÂÆπ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="border-b pb-4">
                        <div class="flex items-center space-x-4 mb-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="lunch" value="1" class="w-5 h-5 text-blue-600 rounded">
                                <span class="ml-2 font-medium">ÊòºÈ£ü</span>
                            </label>
                            <label class="text-sm text-gray-600">
                                È£üÊ¨≤: <input type="range" name="lunchAppetite" min="1" max="10" value="5" class="ml-2 w-32">
                                <span class="ml-2" id="lunch-appetite-value">5</span>/10
                            </label>
                        </div>
                        <textarea name="lunchContent" rows="2" placeholder="È£ü‰∫ãÂÜÖÂÆπ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="border-b pb-4">
                        <div class="flex items-center space-x-4 mb-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="dinner" value="1" class="w-5 h-5 text-blue-600 rounded">
                                <span class="ml-2 font-medium">Â§ïÈ£ü</span>
                            </label>
                            <label class="text-sm text-gray-600">
                                È£üÊ¨≤: <input type="range" name="dinnerAppetite" min="1" max="10" value="5" class="ml-2 w-32">
                                <span class="ml-2" id="dinner-appetite-value">5</span>/10
                            </label>
                        </div>
                        <textarea name="dinnerContent" rows="2" placeholder="È£ü‰∫ãÂÜÖÂÆπ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- „Éê„Ç§„Çø„É´„Çµ„Ç§„É≥ -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">„Éê„Ç§„Çø„É´„Çµ„Ç§„É≥</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ΩìÊ∏© (‚ÑÉ)</label>
                        <input type="number" name="temperature" step="0.1" min="30" max="45" placeholder="36.5"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë°ÄÂúß(È´ò)</label>
                        <input type="number" name="bloodPressureHigh" min="50" max="250" placeholder="120"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë°ÄÂúß(‰Ωé)</label>
                        <input type="number" name="bloodPressureLow" min="30" max="150" placeholder="80"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ËÑàÊãç</label>
                        <input type="number" name="pulse" min="30" max="200" placeholder="70"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SpO2 (%)</label>
                        <input type="number" name="spo2" min="50" max="100" placeholder="98"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Ê∞óÂàÜÁä∂ÊÖã -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ê∞óÂàÜÁä∂ÊÖã</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∞óÂàÜ„Çπ„Ç≥„Ç¢</label>
                        <input type="range" name="moodScore" min="1" max="10" value="5" class="w-full" id="mood-score">
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>üò¢ „Å®„Å¶„ÇÇÊÇ™„ÅÑ</span>
                            <span id="mood-score-value" class="font-semibold text-lg">5</span>
                            <span>üòä „Å®„Å¶„ÇÇËâØ„ÅÑ</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∞óÂàÜË©≥Á¥∞</label>
                        <textarea name="moodDetail" rows="3" placeholder="‰ªäÊó•„ÅÆÊ∞óÂàÜ„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Ë∫´‰Ωì„Ç±„Ç¢„ÉªÊ¥ªÂãï -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ë∫´‰Ωì„Ç±„Ç¢„ÉªÊ¥ªÂãï</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="bathing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">ÂÖ•Êµ¥</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="faceWash" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">Ê¥óÈù¢</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="toothBrushing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">Ê≠ØÁ£®„Åç</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="exercise" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">ÈÅãÂãï</span>
                    </label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÅãÂãïÂÜÖÂÆπ</label>
                        <input type="text" name="exerciseType" placeholder="Êï£Ê≠©„ÄÅ‰ΩìÊìç„Å™„Å©"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê≠©Êï∞</label>
                        <input type="number" name="steps" placeholder="0"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Ê∞ó‰ªò„Åç„Éª„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥ -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ê∞ó‰ªò„Åç„Éª„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊÄù„Å£„Åü„Åì„Å®</label>
                        <textarea name="thoughts" rows="2" placeholder="‰ªäÊó•ÊÄù„Å£„Åü„Åì„Å®„ÇíËá™Áî±„Å´Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊÑü„Åò„Åü„Åì„Å®</label>
                        <textarea name="feelings" rows="2" placeholder="‰ªäÊó•ÊÑü„Åò„Åü„Åì„Å®„ÇíËá™Áî±„Å´Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂøÉÈÖç‰∫ã</label>
                        <textarea name="concerns" rows="2" placeholder="ÂøÉÈÖç„Å™„Åì„Å®„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áõ∏Ë´á„Åó„Åü„ÅÑ„Åì„Å®</label>
                        <textarea name="consultation" rows="2" placeholder="ËÅ∑Âì°„Å´Áõ∏Ë´á„Åó„Åü„ÅÑ„Åì„Å®„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- „Åß„Åç„Åü„Åì„Å®„ÉªÊîπÂñÑ„Åó„Åü„ÅÑ„Åì„Å® -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">„Åß„Åç„Åü„Åì„Å®„ÉªÊîπÂñÑ„Åó„Åü„ÅÑ„Åì„Å®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ªäÊó•„Åß„Åç„Åü„Åì„Å®</label>
                        <textarea name="achievements" rows="3" placeholder="‰ªäÊó•ÈÅîÊàê„Åß„Åç„Åü„Åì„Å®„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Çà„ÇäËâØ„Åè„Åó„Åü„ÅÑ„Åì„Å®</label>
                        <textarea name="improvements" rows="3" placeholder="ÊîπÂñÑ„Åó„Åü„ÅÑ„Åì„Å®„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- „Éú„Çø„É≥ -->
            <div class="flex gap-4">
                <button type="submit" id="save-button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                    ‰øùÂ≠ò„Åô„Çã
                </button>
                <button type="button" onclick="loadPreviousData()"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
                    ÂâçÂõû„Éá„Éº„ÇøË™≠Ëæº
                </button>
            </div>
        </form>

        <div id="success-message" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded"></div>
    </div>
</div>

<script>
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÈñ¢Êï∞
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    // ÂàùÊúüÂåñ
    (async function initDailyRecord() {
        try {
            const user = await window.WhaleStorage.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Êó•‰ªòË°®Á§∫
            const today = new Date();
            document.getElementById('record-date').textContent = 
                today.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // ‰ªäÊó•„ÅÆË®òÈå≤ÂèñÂæó
            const record = await window.WhaleStorage.getTodayRecord(user._id);
            if (record && record._id) {
                loadRecordData(record);
            }

            // „Çπ„É©„Ç§„ÉÄ„ÉºË®≠ÂÆö
            setupSliders();

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
            setupFormSubmit(user);

        } catch (error) {
            console.error('Daily record initialization error:', error);
            window.showToast('ÂàùÊúüÂåñ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        }
    })();

    // „Çπ„É©„Ç§„ÉÄ„ÉºË®≠ÂÆö
    function setupSliders() {
        ['breakfast', 'lunch', 'dinner'].forEach(meal => {
            const slider = document.querySelector(`input[name="${meal}Appetite"]`);
            const display = document.getElementById(`${meal}-appetite-value`);
            if (slider && display) {
                slider.addEventListener('input', () => display.textContent = slider.value);
            }
        });

        const moodSlider = document.getElementById('mood-score');
        const moodDisplay = document.getElementById('mood-score-value');
        if (moodSlider && moodDisplay) {
            moodSlider.addEventListener('input', () => moodDisplay.textContent = moodSlider.value);
        }
    }

    // Ë®òÈå≤„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    function loadRecordData(record) {
        const form = document.getElementById('daily-record-form');
        Object.keys(record).forEach(key => {
            const input = form.elements[key];
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = record[key] === true || record[key] === '1';
                } else {
                    input.value = record[key] || '';
                }
            }
        });
    }

    // ÂâçÂõû„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    async function loadPreviousData() {
        try {
            const user = await window.WhaleStorage.getCurrentUser();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            const records = await window.WhaleStorage.getDailyRecords(
                user._id,
                yesterday.toISOString().split('T')[0],
                yesterday.toISOString().split('T')[0]
            );

            if (records.length > 0) {
                loadRecordData(records[0]);
                window.showToast('ÂâçÂõû„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
            } else {
                window.showToast('ÂâçÂõû„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
            }
        } catch (error) {
            console.error('Load previous data error:', error);
            window.showToast('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº', 'error');
        }
    }

    // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ë®≠ÂÆö
    function setupFormSubmit(user) {
        const form = document.getElementById('daily-record-form');
        const button = document.getElementById('save-button');
        const successDiv = document.getElementById('success-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            button.disabled = true;
            button.textContent = '‰øùÂ≠ò‰∏≠...';

            try {
                const formData = new FormData(form);
                const data = {
                    userId: user._id,
                    organizationId: user.organizationId,
                    recordDate: new Date().toISOString().split('T')[0]
                };

                // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂ§âÊèõ
                for (let [key, value] of formData.entries()) {
                    if (form.elements[key].type === 'checkbox') {
                        data[key] = form.elements[key].checked;
                    } else if (form.elements[key].type === 'number') {
                        data[key] = value ? parseFloat(value) : null;
                    } else {
                        data[key] = value || null;
                    }
                }

                // ‰øùÂ≠ò
                await window.WhaleStorage.saveDailyRecord(data);

                successDiv.textContent = '‚úÖ Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
                successDiv.classList.remove('hidden');
                window.showToast('Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');

                setTimeout(() => successDiv.classList.add('hidden'), 3000);

            } catch (error) {
                console.error('Save error:', error);
                window.showToast('‰øùÂ≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                button.disabled = false;
                button.textContent = '‰øùÂ≠ò„Åô„Çã';
            }
        });
    }
</script>
