<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Êó•„ÄÖ„ÅÆË®òÈå≤</h2>
                <p class="text-sm text-gray-600 mt-1" id="record-date"></p>
            </div>
            <button onclick="loadPage('dashboard.html')" 
                    class="text-blue-600 hover:text-blue-800 font-medium">
                ‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã
            </button>
        </div>

        <form id="daily-record-form" class="space-y-6">
            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Âü∫Êú¨ÊÉÖÂ†±</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ëµ∑Â∫äÊôÇÈñì</label>
                        <input type="time" name="wakeUpTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Â∞±ÂØùÊôÇÈñì</label>
                        <input type="time" name="sleepTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄöÊâÄÊôÇÈñì</label>
                        <input type="time" name="arrivalTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄÄÊâÄÊôÇÈñì</label>
                        <input type="time" name="departureTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- È£ü‰∫ã -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">È£ü‰∫ã</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="breakfast" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">ÊúùÈ£ü</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="lunch" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">ÊòºÈ£ü</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="dinner" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">Â§ïÈ£ü</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- „Éê„Ç§„Çø„É´„Çµ„Ç§„É≥ -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">„Éê„Ç§„Çø„É´„Çµ„Ç§„É≥</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ΩìÊ∏© (‚ÑÉ)</label>
                        <input type="number" name="temperature" step="0.1" min="30" max="45" placeholder="36.5"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë°ÄÂúß(È´ò)</label>
                        <input type="number" name="bloodPressureHigh" min="50" max="250" placeholder="120"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë°ÄÂúß(‰Ωé)</label>
                        <input type="number" name="bloodPressureLow" min="30" max="150" placeholder="80"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ËÑàÊãç</label>
                        <input type="number" name="pulse" min="30" max="200" placeholder="70"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SpO2 (%)</label>
                        <input type="number" name="spo2" min="50" max="100" placeholder="98"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Ê∞óÂàÜÁä∂ÊÖã -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ê∞óÂàÜÁä∂ÊÖã</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∞óÂàÜ„Çπ„Ç≥„Ç¢</label>
                        <input type="range" name="moodScore" min="1" max="10" value="5" class="w-full" id="mood-score">
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>üò¢ „Å®„Å¶„ÇÇÊÇ™„ÅÑ</span>
                            <span id="mood-score-value" class="font-semibold text-lg">5</span>
                            <span>üòä „Å®„Å¶„ÇÇËâØ„ÅÑ</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∞óÂàÜË©≥Á¥∞</label>
                        <textarea name="moodDetail" rows="3" placeholder="‰ªäÊó•„ÅÆÊ∞óÂàÜ„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Ë∫´‰Ωì„Ç±„Ç¢„ÉªÊ¥ªÂãï -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ë∫´‰Ωì„Ç±„Ç¢„ÉªÊ¥ªÂãï</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="bathing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">ÂÖ•Êµ¥</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="faceWash" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">Ê¥óÈù¢</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="toothBrushing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">Ê≠ØÁ£®„Åç</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="exercise" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">ÈÅãÂãï</span>
                    </label>
                </div>
            </div>

            <!-- „Éú„Çø„É≥ -->
            <div class="flex gap-4">
                <button type="submit" id="save-button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                    ‰øùÂ≠ò„Åô„Çã
                </button>
            </div>
        </form>

        <div id="success-message" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded"></div>
    </div>
</div>

<script>
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    (async function initDailyRecord() {
        try {
            const user = await window.WhaleStorage.getCurrentUser();
            if (!user) {
                window.showToast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                window.location.href = 'login.html';
                return;
            }

            // Êó•‰ªòË°®Á§∫
            const today = new Date();
            document.getElementById('record-date').textContent = 
                today.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // ‰ªäÊó•„ÅÆË®òÈå≤ÂèñÂæó
            const record = await window.WhaleStorage.getTodayRecord(user._id);
            if (record) {
                loadRecordData(record);
            }

            // „Çπ„É©„Ç§„ÉÄ„ÉºË®≠ÂÆö
            const moodSlider = document.getElementById('mood-score');
            const moodDisplay = document.getElementById('mood-score-value');
            if (moodSlider && moodDisplay) {
                moodSlider.addEventListener('input', () => moodDisplay.textContent = moodSlider.value);
            }

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
            setupFormSubmit(user);

        } catch (error) {
            console.error('Daily record initialization error:', error);
            window.showToast('ÂàùÊúüÂåñ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
        }
    })();

    function loadRecordData(record) {
        const form = document.getElementById('daily-record-form');
        Object.keys(record).forEach(key => {
            const input = form.elements[key];
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = record[key] === true || record[key] === '1' || record[key] === 1;
                } else {
                    input.value = record[key] || '';
                }
            }
        });
    }

    function setupFormSubmit(user) {
        const form = document.getElementById('daily-record-form');
        const button = document.getElementById('save-button');
        const successDiv = document.getElementById('success-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            button.disabled = true;
            button.textContent = '‰øùÂ≠ò‰∏≠...';

            try {
                const formData = new FormData(form);
                const data = {
                    userId: user._id,
                    recordDate: new Date().toISOString().split('T')[0]
                };

                // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂ§âÊèõ
                for (let [key, value] of formData.entries()) {
                    if (form.elements[key].type === 'checkbox') {
                        data[key] = form.elements[key].checked;
                    } else if (form.elements[key].type === 'number') {
                        data[key] = value ? parseFloat(value) : null;
                    } else {
                        data[key] = value || null;
                    }
                }

                // ‰øùÂ≠ò
                await window.WhaleStorage.saveDailyRecord(data);

                successDiv.textContent = '‚úÖ Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
                successDiv.classList.remove('hidden');
                window.showToast('Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');

                setTimeout(() => successDiv.classList.add('hidden'), 3000);

            } catch (error) {
                console.error('Save error:', error);
                window.showToast('‰øùÂ≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '‰øùÂ≠ò„Åô„Çã';
            }
        });
    }
</script>
