<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">日々の記録</h2>
                <p class="text-sm text-gray-600 mt-1" id="record-date"></p>
            </div>
            <button onclick="loadPage('dashboard.html')" 
                    class="text-blue-600 hover:text-blue-800 font-medium">
                ← ダッシュボードに戻る
            </button>
        </div>

        <form id="daily-record-form" class="space-y-6">
            <!-- 基本情報 -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">基本情報</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">起床時間</label>
                        <input type="time" name="wakeUpTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">就寝時間</label>
                        <input type="time" name="sleepTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">通所時間</label>
                        <input type="time" name="arrivalTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">退所時間</label>
                        <input type="time" name="departureTime" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- 食事 -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">食事</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="breakfast" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">朝食</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="lunch" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">昼食</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="dinner" value="1" class="w-5 h-5 text-blue-600 rounded">
                            <span class="ml-2 font-medium">夕食</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- バイタルサイン -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">バイタルサイン</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">体温 (℃)</label>
                        <input type="number" name="temperature" step="0.1" min="30" max="45" placeholder="36.5"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">血圧(高)</label>
                        <input type="number" name="bloodPressureHigh" min="50" max="250" placeholder="120"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">血圧(低)</label>
                        <input type="number" name="bloodPressureLow" min="30" max="150" placeholder="80"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">脈拍</label>
                        <input type="number" name="pulse" min="30" max="200" placeholder="70"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SpO2 (%)</label>
                        <input type="number" name="spo2" min="50" max="100" placeholder="98"
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- 気分状態 -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">気分状態</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">気分スコア</label>
                        <input type="range" name="moodScore" min="1" max="10" value="5" class="w-full" id="mood-score">
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>😢 とても悪い</span>
                            <span id="mood-score-value" class="font-semibold text-lg">5</span>
                            <span>😊 とても良い</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">気分詳細</label>
                        <textarea name="moodDetail" rows="3" placeholder="今日の気分について詳しく記入してください"
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- 身体ケア・活動 -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">身体ケア・活動</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="bathing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">入浴</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="faceWash" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">洗面</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="toothBrushing" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">歯磨き</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="exercise" value="1" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2">運動</span>
                    </label>
                </div>
            </div>

            <!-- ボタン -->
            <div class="flex gap-4">
                <button type="submit" id="save-button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                    保存する
                </button>
            </div>
        </form>

        <div id="success-message" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded"></div>
    </div>
</div>

<script>
    function loadPage(url) {
        htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML', pushUrl: true });
    }

    (async function initDailyRecord() {
        try {
            const user = await window.WhaleStorage.getCurrentUser();
            if (!user) {
                window.showToast('ログインが必要です', 'error');
                window.location.href = 'login.html';
                return;
            }

            // 日付表示
            const today = new Date();
            document.getElementById('record-date').textContent = 
                today.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // 今日の記録取得
            const record = await window.WhaleStorage.getTodayRecord(user._id);
            if (record) {
                loadRecordData(record);
            }

            // スライダー設定
            const moodSlider = document.getElementById('mood-score');
            const moodDisplay = document.getElementById('mood-score-value');
            if (moodSlider && moodDisplay) {
                moodSlider.addEventListener('input', () => moodDisplay.textContent = moodSlider.value);
            }

            // フォーム送信
            setupFormSubmit(user);

        } catch (error) {
            console.error('Daily record initialization error:', error);
            window.showToast('初期化エラーが発生しました: ' + error.message, 'error');
        }
    })();

    function loadRecordData(record) {
        const form = document.getElementById('daily-record-form');
        Object.keys(record).forEach(key => {
            const input = form.elements[key];
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = record[key] === true || record[key] === '1' || record[key] === 1;
                } else {
                    input.value = record[key] || '';
                }
            }
        });
    }

    function setupFormSubmit(user) {
        const form = document.getElementById('daily-record-form');
        const button = document.getElementById('save-button');
        const successDiv = document.getElementById('success-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            button.disabled = true;
            button.textContent = '保存中...';

            try {
                const formData = new FormData(form);
                const data = {
                    userId: user._id,
                    recordDate: new Date().toISOString().split('T')[0]
                };

                // フォームデータを変換
                for (let [key, value] of formData.entries()) {
                    if (form.elements[key].type === 'checkbox') {
                        data[key] = form.elements[key].checked;
                    } else if (form.elements[key].type === 'number') {
                        data[key] = value ? parseFloat(value) : null;
                    } else {
                        data[key] = value || null;
                    }
                }

                // 保存
                await window.WhaleStorage.saveDailyRecord(data);

                successDiv.textContent = '✅ 記録を保存しました';
                successDiv.classList.remove('hidden');
                window.showToast('記録を保存しました', 'success');

                setTimeout(() => successDiv.classList.add('hidden'), 3000);

            } catch (error) {
                console.error('Save error:', error);
                window.showToast('保存エラーが発生しました: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '保存する';
            }
        });
    }
</script>
