<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新規登録 - WHALE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-blue-600 text-white text-4xl p-4 rounded-full mb-4">
                    🐋
                </div>
                <h1 class="text-3xl font-bold text-gray-800">WHALE 新規登録</h1>
                <p class="text-sm text-gray-600 mt-2">施設・機関の情報を登録してください</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

            <form id="register-form" class="space-y-8">
                <!-- 施設・機関情報 -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">施設・機関情報</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                施設名（機関名） <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                施設機関ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">英数字、ハイフン、アンダースコアのみ</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                郵便番号 <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                住所 <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                電話番号 <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="organizationPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                創設年月日
                            </label>
                            <input type="date" name="organizationEstablishedDate"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- 管理者情報 -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">管理者情報</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                管理者名 <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                管理者名（フリガナ） <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminNameKana" required
                                   pattern="[\u30A0-\u30FF]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                郵便番号 <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                電話番号 <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="adminPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                住所 <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                誕生日 <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="adminBirthday" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ログイン情報 -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ログイン情報</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                管理者ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminUserId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   autocomplete="username"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                パスワード <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPassword" required
                                   minlength="8"
                                   id="password"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">8文字以上で入力してください</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                パスワード（確認） <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPasswordConfirmation" required
                                   minlength="8"
                                   id="password-confirmation"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ボタン -->
                <div class="flex gap-4">
                    <button type="submit"
                            id="register-button"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        登録する
                    </button>
                    <a href="login.html"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg text-center transition duration-200">
                        キャンセル
                    </a>
                </div>
            </form>
        </div>

        <div class="text-center mt-6 text-sm text-gray-600">
            <p>&copy; 2025 WHALE System. Developed by Hirotoshi Uchida</p>
        </div>
    </div>

    <script type="module" src="js/storage.js"></script>
    <script type="module" src="js/auth.js"></script>

    <script>
        // グローバル変数
        window.WHALE = {
            API_URL: 'https://whale-backend-84p5.onrender.com',
            GITHUB_PAGES_URL: 'https://uchida16104.github.io/WHALE',
            VERSION: '2.0.0'
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🐋 Register page loaded');

            // ストレージ初期化
            await window.WhaleStorage.init();

            const form = document.getElementById('register-form');
            const button = document.getElementById('register-button');
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');

            // パスワード確認バリデーション
            const password = document.getElementById('password');
            const passwordConfirmation = document.getElementById('password-confirmation');

            passwordConfirmation.addEventListener('input', () => {
                if (password.value !== passwordConfirmation.value) {
                    passwordConfirmation.setCustomValidity('パスワードが一致しません');
                } else {
                    passwordConfirmation.setCustomValidity('');
                }
            });

            // フォーム送信処理
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // パスワード一致確認
                if (password.value !== passwordConfirmation.value) {
                    errorDiv.textContent = 'パスワードが一致しません';
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                    return;
                }

                // ボタン無効化
                button.disabled = true;
                button.textContent = '登録中...';
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');

                try {
                    const formData = new FormData(form);
                    const registrationData = {
                        organizationName: formData.get('organizationName'),
                        organizationId: formData.get('organizationId'),
                        organizationPostalCode: formData.get('organizationPostalCode'),
                        organizationAddress: formData.get('organizationAddress'),
                        organizationPhone: formData.get('organizationPhone'),
                        organizationEstablishedDate: formData.get('organizationEstablishedDate'),
                        adminName: formData.get('adminName'),
                        adminNameKana: formData.get('adminNameKana'),
                        adminPostalCode: formData.get('adminPostalCode'),
                        adminAddress: formData.get('adminAddress'),
                        adminPhone: formData.get('adminPhone'),
                        adminBirthday: formData.get('adminBirthday'),
                        adminUserId: formData.get('adminUserId'),
                        adminPassword: formData.get('adminPassword')
                    };

                    // バリデーション
                    if (!registrationData.organizationName || !registrationData.organizationId) {
                        throw new Error('必須項目を入力してください');
                    }

                    // 登録実行
                    const result = await window.WhaleAuth.register(registrationData);

                    if (result.success) {
                        console.log('✅ Registration successful');
                        successDiv.textContent = '登録が完了しました。ダッシュボードに移動します...';
                        successDiv.classList.remove('hidden');

                        // 2秒後にダッシュボードへリダイレクト
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        throw new Error('登録に失敗しました');
                    }
                } catch (error) {
                    console.error('❌ Registration error:', error);
                    errorDiv.textContent = error.message || '登録に失敗しました';
                    errorDiv.classList.remove('hidden');
                    window.scrollTo(0, 0);

                    // ボタン有効化
                    button.disabled = false;
                    button.textContent = '登録する';
                }
            });
        });
    </script>
</body>
</html>
