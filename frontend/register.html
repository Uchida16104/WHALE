<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°è¦ç™»éŒ² - WHALE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.find.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-blue-600 text-white text-4xl p-4 rounded-full mb-4">
                    ğŸ‹
                </div>
                <h1 class="text-3xl font-bold text-gray-800">WHALE æ–°è¦ç™»éŒ²</h1>
                <p class="text-sm text-gray-600 mt-2">æ–½è¨­ãƒ»æ©Ÿé–¢ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
            <div id="info-message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ç™»éŒ²å¾Œã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«è‡ªå‹•çš„ã«ç§»å‹•ã—ã¾ã™ã€‚
            </div>

            <form id="register-form" class="space-y-8">
                <!-- æ–½è¨­ãƒ»æ©Ÿé–¢æƒ…å ± -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">1</span>
                        æ–½è¨­ãƒ»æ©Ÿé–¢æƒ…å ±
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–½è¨­åï¼ˆæ©Ÿé–¢åï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: ç¤¾ä¼šç¦ç¥‰æ³•äºº â—‹â—‹ä¼š">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–½è¨­æ©Ÿé–¢ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: facility_001">
                            <p class="text-xs text-gray-500 mt-1">è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯èƒ½</p>
                            <p class="text-xs text-red-500 mt-1">â€»ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å¿…è¦ã¨ãªã‚Šã¾ã™ã®ã§å¿…ãšæ§ãˆã¦ãã ã•ã„</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                éƒµä¾¿ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ä½æ‰€ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒº...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                é›»è©±ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="organizationPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å‰µè¨­å¹´æœˆæ—¥
                            </label>
                            <input type="date" name="organizationEstablishedDate"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†è€…æƒ…å ± -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">2</span>
                        ç®¡ç†è€…æƒ…å ±
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…å <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: å±±ç”° å¤ªéƒ">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminNameKana" required
                                   pattern="[\u30A0-\u30FF]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                éƒµä¾¿ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                é›»è©±ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="adminPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ä½æ‰€ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒº...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                èª•ç”Ÿæ—¥ <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="adminBirthday" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ± -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">3</span>
                        ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminUserId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   autocomplete="username"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ä¾‹: admin001">
                            <p class="text-xs text-gray-500 mt-1">è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯èƒ½</p>
                            <p class="text-xs text-red-500 mt-1">â€»ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å¿…è¦ã¨ãªã‚Šã¾ã™ã®ã§å¿…ãšæ§ãˆã¦ãã ã•ã„</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPassword" required
                                   minlength="8"
                                   id="password"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="8æ–‡å­—ä»¥ä¸Š">
                            <p class="text-xs text-gray-500 mt-1">8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPasswordConfirmation" required
                                   minlength="8"
                                   id="password-confirmation"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ç¢ºèªã®ãŸã‚å†å…¥åŠ›">
                        </div>
                    </div>
                </div>

                <!-- ãƒœã‚¿ãƒ³ -->
                <div class="flex gap-4">
                    <button type="submit"
                            id="register-button"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ç™»éŒ²ã™ã‚‹
                    </button>
                    <a href="login.html"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg text-center transition duration-200">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </a>
                </div>
            </form>
        </div>

        <div class="text-center mt-6 text-sm text-gray-600">
            <p>&copy; 2025 WHALE System v2.3.0</p>
            <p class="text-xs mt-1">Developed by Hirotoshi Uchida</p>
        </div>
    </div>

    <script>
        window.WHALE = {
            API_URL: 'https://whale-backend-84p5.onrender.com',
            VERSION: '2.3.0'
        };
    </script>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/storage.js"></script>
    <script type="module" src="js/auth.js"></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ‹ Register page loaded (v2.3.0)');

            try {
                // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 100));

                await window.WhaleStorage.init();
                console.log('âœ… Storage initialized');

                const form = document.getElementById('register-form');
                const button = document.getElementById('register-button');
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                const infoDiv = document.getElementById('info-message');

                // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                infoDiv.classList.remove('hidden');

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                const password = document.getElementById('password');
                const passwordConfirmation = document.getElementById('password-confirmation');

                passwordConfirmation.addEventListener('input', () => {
                    if (password.value !== passwordConfirmation.value) {
                        passwordConfirmation.setCustomValidity('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                    } else {
                        passwordConfirmation.setCustomValidity('');
                    }
                });

                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ç¢ºèª
                    if (password.value !== passwordConfirmation.value) {
                        errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                        errorDiv.classList.remove('hidden');
                        successDiv.classList.add('hidden');
                        infoDiv.classList.add('hidden');
                        return;
                    }

                    button.disabled = true;
                    button.textContent = 'ç™»éŒ²ä¸­...';
                    errorDiv.classList.add('hidden');
                    successDiv.classList.add('hidden');
                    infoDiv.classList.add('hidden');

                    try {
                        const formData = new FormData(form);
                        const registrationData = {
                            organizationName: formData.get('organizationName').trim(),
                            organizationId: formData.get('organizationId').trim(),
                            organizationPostalCode: formData.get('organizationPostalCode').trim(),
                            organizationAddress: formData.get('organizationAddress').trim(),
                            organizationPhone: formData.get('organizationPhone').trim(),
                            organizationEstablishedDate: formData.get('organizationEstablishedDate'),
                            adminName: formData.get('adminName').trim(),
                            adminNameKana: formData.get('adminNameKana').trim(),
                            adminPostalCode: formData.get('adminPostalCode').trim(),
                            adminAddress: formData.get('adminAddress').trim(),
                            adminPhone: formData.get('adminPhone').trim(),
                            adminBirthday: formData.get('adminBirthday'),
                            adminUserId: formData.get('adminUserId').trim(),
                            adminPassword: formData.get('adminPassword')
                        };

                        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (!registrationData.organizationName || !registrationData.organizationId) {
                            throw new Error('æ–½è¨­ãƒ»æ©Ÿé–¢æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                        }

                        if (!registrationData.adminName || !registrationData.adminUserId || !registrationData.adminPassword) {
                            throw new Error('ç®¡ç†è€…æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                        }

                        console.log('ğŸ“ Starting registration process...');
                        console.log('Organization ID:', registrationData.organizationId);
                        console.log('Admin User ID:', registrationData.adminUserId);

                        const result = await window.WhaleAuth.register(registrationData);

                        if (result.success) {
                            console.log('âœ… Registration successful');
                            successDiv.innerHTML = `
                                <div class="font-bold">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>
                                <div class="text-sm mt-2">
                                    <strong>æ–½è¨­æ©Ÿé–¢ID:</strong> ${registrationData.organizationId}<br>
                                    <strong>ç®¡ç†è€…ID:</strong> ${registrationData.adminUserId}
                                </div>
                                <div class="text-xs mt-2">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™...</div>
                            `;
                            successDiv.classList.remove('hidden');

                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else {
                            throw new Error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('âŒ Registration error:', error);
                        errorDiv.textContent = error.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        errorDiv.classList.remove('hidden');
                        window.scrollTo(0, 0);

                        button.disabled = false;
                        button.textContent = 'ç™»éŒ²ã™ã‚‹';
                    }
                });

                console.log('âœ… Register page ready');

            } catch (error) {
                console.error('âŒ Register page initialization error:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
