<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°è¦ç™»éŒ² - WHALE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
    <!-- PouchDB Find Plugin (CRITICAL) -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb-find@8.0.1/dist/pouchdb.find.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-blue-600 text-white text-4xl p-4 rounded-full mb-4">
                    ğŸ‹
                </div>
                <h1 class="text-3xl font-bold text-gray-800">WHALE æ–°è¦ç™»éŒ²</h1>
                <p class="text-sm text-gray-600 mt-2">æ–½è¨­ãƒ»æ©Ÿé–¢ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

            <form id="register-form" class="space-y-8">
                <!-- æ–½è¨­ãƒ»æ©Ÿé–¢æƒ…å ± -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">æ–½è¨­ãƒ»æ©Ÿé–¢æƒ…å ±</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–½è¨­åï¼ˆæ©Ÿé–¢åï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–½è¨­æ©Ÿé–¢ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                éƒµä¾¿ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ä½æ‰€ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="organizationAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                é›»è©±ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="organizationPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å‰µè¨­å¹´æœˆæ—¥
                            </label>
                            <input type="date" name="organizationEstablishedDate"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ç®¡ç†è€…æƒ…å ± -->
                <div class="border-b pb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ç®¡ç†è€…æƒ…å ±</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…å <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminNameKana" required
                                   pattern="[\u30A0-\u30FF]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                éƒµä¾¿ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminPostalCode" required
                                   placeholder="000-0000"
                                   pattern="\d{3}-\d{4}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                é›»è©±ç•ªå· <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="adminPhone" required
                                   placeholder="000-0000-0000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ä½æ‰€ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminAddress" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                èª•ç”Ÿæ—¥ <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="adminBirthday" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ± -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç®¡ç†è€…ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="adminUserId" required
                                   pattern="[a-zA-Z0-9_-]+"
                                   autocomplete="username"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPassword" required
                                   minlength="8"
                                   id="password"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰ <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="adminPasswordConfirmation" required
                                   minlength="8"
                                   id="password-confirmation"
                                   autocomplete="new-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ãƒœã‚¿ãƒ³ -->
                <div class="flex gap-4">
                    <button type="submit"
                            id="register-button"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ç™»éŒ²ã™ã‚‹
                    </button>
                    <a href="login.html"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg text-center transition duration-200">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </a>
                </div>
            </form>
        </div>

        <div class="text-center mt-6 text-sm text-gray-600">
            <p>&copy; 2025 WHALE System. Developed by Hirotoshi Uchida</p>
        </div>
    </div>

    <script type="module" src="js/storage.js"></script>
    <script type="module" src="js/auth.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.WHALE = {
            API_URL: 'https://whale-backend-84p5.onrender.com',
            GITHUB_PAGES_URL: 'https://uchida16104.github.io/WHALE',
            VERSION: '2.0.0'
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ‹ Register page loaded');

            try {
                // PouchDB Find Pluginç¢ºèª
                if (typeof PouchDB === 'undefined') {
                    throw new Error('PouchDB is not loaded');
                }
                
                const testDb = new PouchDB('test_register_db');
                if (typeof testDb.find !== 'function') {
                    throw new Error('PouchDB Find Plugin is required');
                }
                await testDb.destroy();
                console.log('âœ… PouchDB Find Plugin confirmed');

                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–
                await window.WhaleStorage.init();

                const form = document.getElementById('register-form');
                const button = document.getElementById('register-button');
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                const password = document.getElementById('password');
                const passwordConfirmation = document.getElementById('password-confirmation');

                passwordConfirmation.addEventListener('input', () => {
                    if (password.value !== passwordConfirmation.value) {
                        passwordConfirmation.setCustomValidity('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                    } else {
                        passwordConfirmation.setCustomValidity('');
                    }
                });

                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ç¢ºèª
                    if (password.value !== passwordConfirmation.value) {
                        errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                        errorDiv.classList.remove('hidden');
                        successDiv.classList.add('hidden');
                        return;
                    }

                    // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
                    button.disabled = true;
                    button.textContent = 'ç™»éŒ²ä¸­...';
                    errorDiv.classList.add('hidden');
                    successDiv.classList.add('hidden');

                    try {
                        const formData = new FormData(form);
                        const registrationData = {
                            organizationName: formData.get('organizationName'),
                            organizationId: formData.get('organizationId'),
                            organizationPostalCode: formData.get('organizationPostalCode'),
                            organizationAddress: formData.get('organizationAddress'),
                            organizationPhone: formData.get('organizationPhone'),
                            organizationEstablishedDate: formData.get('organizationEstablishedDate'),
                            adminName: formData.get('adminName'),
                            adminNameKana: formData.get('adminNameKana'),
                            adminPostalCode: formData.get('adminPostalCode'),
                            adminAddress: formData.get('adminAddress'),
                            adminPhone: formData.get('adminPhone'),
                            adminBirthday: formData.get('adminBirthday'),
                            adminUserId: formData.get('adminUserId'),
                            adminPassword: formData.get('adminPassword')
                        };

                        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (!registrationData.organizationName || !registrationData.organizationId) {
                            throw new Error('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        }

                        // ç™»éŒ²å®Ÿè¡Œ
                        console.log('ğŸ” Attempting registration...');
                        const result = await window.WhaleAuth.register(registrationData);

                        if (result.success) {
                            console.log('âœ… Registration successful');
                            successDiv.textContent = 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™...';
                            successDiv.classList.remove('hidden');

                            // 2ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                        } else {
                            throw new Error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('âŒ Registration error:', error);
                        errorDiv.textContent = error.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        errorDiv.classList.remove('hidden');
                        window.scrollTo(0, 0);

                        // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                        button.disabled = false;
                        button.textContent = 'ç™»éŒ²ã™ã‚‹';
                    }
                });

            } catch (error) {
                console.error('âŒ Register page initialization error:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
